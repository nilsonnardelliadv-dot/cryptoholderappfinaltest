<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CryptoPanel HOLDER PRO - Sistema para Investidores de Longo Prazo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        dark: { 950: '#05070a', 900: '#0b0e14', 800: '#151a23', 700: '#232a3b', 600: '#374151' },
                        brand: { 500: '#3b82f6', 600: '#2563eb' },
                        score: { high: '#10b981', mid: '#f59e0b', low: '#ef4444' },
                        orange: { 400: '#fb923c', 500: '#f97316', 600: '#ea580c', 700: '#c2410c' },
                        holder: {
                            accumulation: '#22c55e',
                            holding: '#3b82f6', 
                            profit_taking: '#ef4444',
                            dca_zone: '#8b5cf6'
                        }
                    },
                    animation: { 
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pulse-accumulation': 'pulse 2s ease-in-out infinite'
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #05070a; color: #e5e7eb; overflow-x: hidden; padding-bottom: 400px; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0b0e14; }
        ::-webkit-scrollbar-thumb { background: #232a3b; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
        
        .glass { background: rgba(11, 14, 20, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .table-fixed-header thead { position: sticky; top: 0; z-index: 20; background-color: #0b0e14; }
        .table-row-hover:hover td { background-color: rgba(59, 130, 246, 0.08); }
        
        #metric-tooltip-overlay { 
            position: fixed; bottom: 0; left: 0; right: 0;
            height: auto; max-height: 70vh;
            background-color: #05070a;
            border-top: 1px solid rgba(59, 130, 246, 0.4);
            box-shadow: 0 -10px 60px rgba(0,0,0,0.95);
            z-index: 9999;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex; flex-direction: column; gap: 1rem;
        }
        @media(min-width: 1024px) { #metric-tooltip-overlay { flex-direction: row; max-height: 40vh; } }

        .tooltip-hidden { transform: translateY(110%); opacity: 0; pointer-events: none; }
        .tooltip-visible { transform: translateY(0); opacity: 1; pointer-events: auto; }

        .tip-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #60a5fa; font-weight: 800; margin-bottom: 6px; border-bottom: 1px solid rgba(96, 165, 250, 0.2); display: inline-block; }
        .tip-val { font-size: 0.9rem; color: #d1d5db; line-height: 1.6; }
        .tip-val b { color: #fff; font-weight: 700; }
        
        .card-enter { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .pulse-green { animation: pulseG 0.8s; } .pulse-red { animation: pulseR 0.8s; }
        @keyframes pulseG { 0% { color: #10b981; text-shadow: 0 0 10px rgba(16,185,129,0.5); } 100% { color: inherit; } }
        @keyframes pulseR { 0% { color: #ef4444; text-shadow: 0 0 10px rgba(239,68,68,0.5); } 100% { color: inherit; } }
        .sparkline-path { stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: drawSpark 2s ease-out forwards; }
        @keyframes drawSpark { to { stroke-dashoffset: 0; } }
        .modal-overlay { background-color: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .mobile-full { width: 100%; }
        .mobile-text-sm { font-size: 0.875rem; }
        .mobile-p-3 { padding: 0.75rem; }
        
        @media (max-width: 640px) {
            .card-grid { grid-template-columns: 1fr; gap: 1rem; }
            .card-section { padding: 0.75rem; }
            .card-section-grid { grid-template-columns: 1fr; gap: 0.5rem; }
            .mobile-collapsible { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
            .mobile-collapsible.expanded { max-height: 1000px; }
            .mobile-toggle { display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        }

        .compact-table th, .compact-table td { padding: 0.25rem 0.5rem !important; }
        
        .alert-panel { border-color: rgba(251, 146, 60, 0.5) !important; }
        .alert-header { background-color: rgba(251, 146, 60, 0.1) !important; border-color: rgba(251, 146, 60, 0.3) !important; }
        .alert-button { background-color: #f97316 !important; }
        .alert-button:hover { background-color: #ea580c !important; }
        
        .ranking-row-high { background-color: rgba(16, 185, 129, 0.1) !important; }
        .ranking-row-mid { background-color: rgba(59, 130, 246, 0.1) !important; }
        .ranking-row-low { background-color: rgba(239, 68, 68, 0.1) !important; }
        
        /* Novos estilos HOLDER */
        .holder-phase-accumulation { 
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
            border-left: 4px solid #22c55e;
        }
        
        .holder-phase-holding { 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, rgba(59, 130, 246, 0.05) 100%);
            border-left: 4px solid #3b82f6;
        }
        
        .holder-phase-profit { 
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.05) 100%);
            border-left: 4px solid #ef4444;
        }
        
        .dca-zone-indicator {
            background: rgba(139, 92, 246, 0.2);
            border: 1px dashed rgba(139, 92, 246, 0.5);
            animation: pulse-accumulation 2s infinite;
        }
        
        .historical-band {
            position: absolute;
            width: 100%;
            opacity: 0.1;
            z-index: 1;
        }
        
        .band-0-20 { background: #22c55e; height: 20%; bottom: 0; }
        .band-20-40 { background: #4ade80; height: 20%; bottom: 20%; }
        .band-40-60 { background: #fbbf24; height: 20%; bottom: 40%; }
        .band-60-80 { background: #f97316; height: 20%; bottom: 60%; }
        .band-80-100 { background: #ef4444; height: 20%; bottom: 80%; }
        
        .accumulation-zone {
            border: 2px solid #22c55e;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }
        
        .profit-zone {
            border: 2px solid #ef4444;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body class="antialiased min-h-screen flex flex-col font-sans selection:bg-brand-500 selection:text-white">

    <header class="glass sticky top-0 z-50 border-b border-gray-800 shadow-lg">
        <div class="max-w-[1800px] mx-auto px-2 sm:px-4 h-16 flex items-center justify-between flex-wrap sm:flex-nowrap gap-2 py-2 min-w-[320px]">
            <div class="flex items-center gap-2 sm:gap-4 w-full sm:w-auto justify-between sm:justify-start">
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-br from-holder-accumulation to-holder-holding rounded-lg flex items-center justify-center shadow-lg shadow-green-500/20 cursor-help" data-tip="sys_logo">
                        <i class="fa-solid fa-chart-line text-white text-sm sm:text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-base sm:text-xl text-white tracking-tight">CryptoPanel<span class="text-holder-accumulation">HOLDER</span> <span class="text-[8px] sm:text-[10px] text-gray-500 border border-gray-700 rounded px-1 ml-1 align-top">v3.0 HOLDER PRO</span></h1>
                        <div class="flex items-center gap-1 sm:gap-2 text-[8px] sm:text-[10px] text-gray-400 font-mono mt-0 sm:mt-1">
                            <span class="hidden sm:inline">LONG TERM • ACCUMULATION • PATIENCE</span>
                            <span class="w-1 h-1 rounded-full bg-gray-600 hidden sm:inline"></span>
                            <span id="last-update" data-tip="sys_update">Conectando...</span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-1 sm:hidden">
                    <button id="mobile-menu-toggle" class="p-2 bg-dark-800 border border-gray-700 rounded-lg">
                        <i class="fa-solid fa-bars text-white"></i>
                    </button>
                </div>
            </div>
            <div id="header-controls" class="hidden sm:flex items-center gap-2 sm:gap-3 w-full sm:w-auto justify-end mt-2 sm:mt-0">
                <input id="searchToken" type="text" placeholder="Buscar ativo..." class="bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-sm text-white focus:border-holder-accumulation outline-none w-full sm:w-40 mobile-full">
                <div class="hidden sm:flex flex-col items-end mr-2 cursor-help" data-tip="sys_auto_refresh">
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest">Auto-Refresh</span>
                    <span id="countdown" class="text-xs font-mono font-bold text-holder-accumulation">60s</span>
                </div>
                <div class="flex gap-1 sm:gap-2">
                    <button onclick="App.Export.openModal()" class="p-2 bg-dark-800 hover:text-green-400 border border-gray-700 rounded-lg transition-all min-h-[40px] min-w-[40px] flex items-center justify-center" data-tip="sys_export"><i class="fa-solid fa-file-excel"></i></button>
                    <button id="refreshData" class="group p-2 bg-holder-accumulation hover:bg-green-500 rounded-lg text-white shadow-lg min-h-[40px] min-w-[40px] flex items-center justify-center" data-tip="sys_manual_refresh"><i class="fa-solid fa-rotate group-hover:rotate-180 transition-transform duration-500"></i></button>
                    <button id="openSettings" class="p-2 bg-dark-800 hover:text-yellow-400 border border-gray-700 rounded-lg transition-all min-h-[40px] min-w-[40px] flex items-center justify-center" data-tip="sys_settings"><i class="fa-solid fa-gear"></i></button>
                </div>
            </div>
        </div>
    </header>

    <!-- Barra de Status Holder -->
    <div class="bg-dark-900 border-b border-gray-800 py-2 shadow-inner">
        <div class="max-w-[1800px] mx-auto px-2 sm:px-4 flex flex-col sm:flex-row gap-2 sm:gap-4 overflow-x-auto no-scrollbar items-start sm:items-center">
            <span class="font-bold text-gray-500 uppercase tracking-widest text-[9px] sm:text-[10px] shrink-0 flex items-center cursor-help" data-tip="holder_intro">Estratégia HOLDER:</span>
            <div class="flex flex-wrap gap-1 sm:gap-2 shrink-0 text-xs">
                <span class="px-2 py-1 bg-dark-800 border border-holder-accumulation rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="holder_accumulation"><span class="w-2 h-2 inline-block rounded-full bg-holder-accumulation mr-1"></span>Zona de Acumulação</span>
                <span class="px-2 py-1 bg-dark-800 border border-holder-holding rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="holder_holding"><span class="w-2 h-2 inline-block rounded-full bg-holder-holding mr-1"></span>Manter Posição</span>
                <span class="px-2 py-1 bg-dark-800 border border-holder-profit_taking rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="holder_profit"><span class="w-2 h-2 inline-block rounded-full bg-holder-profit_taking mr-1"></span>Realizar Lucros</span>
                <span class="px-2 py-1 bg-dark-800 border border-holder-dca_zone rounded cursor-help hover:bg-dark-700 transition-colors text-[10px] sm:text-xs" data-tip="holder_dca"><span class="w-2 h-2 inline-block rounded-full bg-holder-dca_zone mr-1"></span>Zona DCA</span>
            </div>
        </div>
    </div>

    <main class="flex-1 max-w-[1800px] mx-auto px-2 sm:px-4 py-4 sm:py-6 w-full gap-4 sm:gap-8 flex flex-col">
        
        <!-- Painel de Status do Mercado (Holder) -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col border-t-4 border-t-holder-accumulation shadow-lg">
                <div class="bg-dark-800/90 p-3 border-b border-gray-700 flex justify-between items-center shrink-0">
                    <h3 class="text-holder-accumulation font-bold text-xs uppercase tracking-wide flex items-center gap-2" data-tip="holder_accumulation_title"><i class="fa-solid fa-layer-group"></i> Zonas de Acumulação</h3>
                </div>
                <div class="overflow-y-auto flex-1 scrollbar-thin max-h-[40vh] sm:max-h-none">
                    <table class="w-full text-left text-[10px] compact-table">
                        <thead class="bg-dark-950 text-gray-500 sticky top-0">
                            <tr>
                                <th class="p-2 font-bold" data-tip="col_ticker">Ativo</th>
                                <th class="p-2 text-right font-bold" data-tip="col_price">Preço</th>
                                <th class="p-2 text-right font-bold" data-tip="col_discount">Desconto Hist.</th>
                            </tr>
                        </thead>
                        <tbody id="list-accumulation" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col border-t-4 border-t-holder-holding shadow-lg">
                <div class="bg-dark-800/90 p-3 border-b border-gray-700 flex justify-between items-center shrink-0">
                    <h3 class="text-holder-holding font-bold text-xs uppercase tracking-wide flex items-center gap-2" data-tip="holder_holding_title"><i class="fa-solid fa-coins"></i> Manter Posição</h3>
                </div>
                <div class="overflow-y-auto flex-1 scrollbar-thin max-h-[40vh] sm:max-h-none">
                    <table class="w-full text-left text-[10px] compact-table">
                        <thead class="bg-dark-950 text-gray-500 sticky top-0">
                            <tr>
                                <th class="p-2 font-bold" data-tip="col_ticker">Ativo</th>
                                <th class="p-2 text-center font-bold" data-tip="col_sma200">SMA200</th>
                                <th class="p-2 text-right font-bold" data-tip="col_risk">Risco/Retorno</th>
                            </tr>
                        </thead>
                        <tbody id="list-holding" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col border-t-4 border-t-holder-profit_taking shadow-lg">
                <div class="bg-dark-800/90 p-3 border-b border-gray-700 flex justify-between items-center shrink-0">
                    <h3 class="text-holder-profit_taking font-bold text-xs uppercase tracking-wide flex items-center gap-2" data-tip="holder_profit_title"><i class="fa-solid fa-trophy"></i> Realizar Lucros</h3>
                </div>
                <div class="overflow-y-auto flex-1 scrollbar-thin max-h-[40vh] sm:max-h-none">
                    <table class="w-full text-left text-[10px] compact-table">
                        <thead class="bg-dark-950 text-gray-500 sticky top-0">
                            <tr>
                                <th class="p-2 font-bold" data-tip="col_ticker">Ativo</th>
                                <th class="p-2 text-right font-bold" data-tip="col_profit">Lucro Potencial</th>
                                <th class="p-2 text-right font-bold" data-tip="col_sell_zone">Zona de Venda</th>
                            </tr>
                        </thead>
                        <tbody id="list-profit" class="text-gray-300 divide-y divide-gray-800"></tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Portfólio Holder Recomendado -->
        <section class="glass rounded-xl overflow-hidden border border-gray-800 flex flex-col h-[400px] shadow-xl">
            <div class="bg-dark-800/80 p-4 border-b border-gray-700 flex justify-between items-center shrink-0">
                <h3 class="text-white font-bold text-sm flex items-center gap-2" data-tip="portfolio_title"><i class="fa-solid fa-star text-yellow-500"></i> Portfólio Holder Recomendado</h3>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-500">Alocação Ideal:</span>
                    <select id="portfolio-strategy" class="bg-dark-800 border border-gray-700 rounded px-2 py-1 text-xs text-white">
                        <option value="conservative">Conservadora (70% BTC/ETH)</option>
                        <option value="balanced" selected>Balanceada (50% BTC/ETH)</option>
                        <option value="growth">Crescimento (30% BTC/ETH)</option>
                    </select>
                </div>
            </div>
            <div class="overflow-y-auto flex-1 scrollbar-thin table-fixed-header table-responsive">
                <table class="w-full text-left text-xs min-w-[700px]">
                    <thead class="text-gray-400 uppercase font-bold tracking-wider text-[10px]">
                        <tr>
                            <th class="p-3 text-center w-12 bg-dark-900">#</th>
                            <th class="p-3 bg-dark-900" data-tip="col_ticker">Ativo</th>
                            <th class="p-3 text-center bg-dark-900" data-tip="col_phase">Fase</th>
                            <th class="p-3 text-center bg-dark-900" data-tip="col_allocation">Alocação</th>
                            <th class="p-3 text-center bg-dark-900" data-tip="col_entry">Entrada Ideal</th>
                            <th class="p-3 text-center bg-dark-900" data-tip="col_target">Alvo 1-2 anos</th>
                            <th class="p-3 text-center bg-dark-900" data-tip="col_score_holder">Score Holder</th>
                            <th class="p-3 text-right bg-dark-900">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="portfolio-body" class="divide-y divide-gray-800 text-gray-300"><tr><td colspan="8" class="p-8 text-center text-gray-600 italic animate-pulse">Carregando portfólio...</td></tr></tbody>
                </table>
            </div>
        </section>

        <!-- Alertas HOLDER (reposicionado e modificado) -->
        <section id="alerts-panel" class="glass rounded-xl overflow-hidden border border-holder-dca_zone flex flex-col shadow-lg dca-zone-indicator">
            <div class="bg-purple-900/20 p-4 border-b border-holder-dca_zone/50 flex justify-between items-center">
                <h3 class="text-holder-dca_zone font-bold text-sm flex items-center gap-2" data-tip="holder_alerts"><i class="fa-solid fa-calendar-check"></i> Alertas de Acumulação (DCA)</h3>
                <button onclick="App.Alerts.openModal()" class="px-3 py-1 bg-holder-dca_zone hover:bg-purple-600 text-white rounded-lg text-xs">+ Novo Alerta DCA</button>
            </div>
            <div class="p-4"><div id="alertsContent" class="space-y-2 max-h-60 overflow-y-auto"></div></div>
        </section>

        <div class="flex flex-col sm:flex-row gap-4 items-center justify-between mt-4">
            <div class="flex items-center gap-2 w-full sm:w-auto">
                <div class="relative group w-full sm:w-64">
                    <input type="text" id="add-input" placeholder="Adicionar ativo (ex: BTC)..." class="w-full bg-dark-900 border border-gray-700 rounded-lg px-4 py-2 text-sm focus:border-holder-accumulation outline-none uppercase shadow-inner transition-all" data-tip="input_add">
                    <button onclick="App.Token.add()" class="absolute right-2 top-1/2 -translate-y-1/2 text-holder-accumulation hover:text-white p-1"><i class="fa-solid fa-plus"></i></button>
                </div>
                <div class="text-[10px] text-gray-500 hidden sm:block">Apenas ativos com fundamentos sólidos</div>
            </div>
            <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider hidden sm:block">Monitoramento de Longo Prazo</div>
        </div>
        
        <!-- Cards de Análise HOLDER -->
        <div id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-4 sm:gap-6 pb-10 card-grid"></div>
    </main>

    <div id="metric-tooltip-overlay" class="tooltip-hidden"></div>

    <!-- Modal de Alertas HOLDER -->
    <div id="alertsModal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md sm:max-w-2xl overflow-hidden mx-2">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Criar Alerta de Acumulação (DCA)</h3>
                <button onclick="App.Alerts.closeModal()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 max-h-96 overflow-y-auto">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Ativo</label>
                        <select id="alert-symbol" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none">
                            <option value="">Selecione um ativo</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Tipo de Alerta</label>
                        <select id="alert-type" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none">
                            <option value="dca_buy">Acumulação (preço cai para)</option>
                            <option value="profit_take">Realizar Lucros (preço sobe para)</option>
                            <option value="rebalance">Rebalancear Portfólio</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Preço Alvo (USDT)</label>
                        <input type="number" id="alert-price" step="0.0001" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none" placeholder="0.00">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Métrica Adicional</label>
                        <select id="alert-metric" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none">
                            <option value="none">Apenas preço</option>
                            <option value="rsi_below_30">RSI abaixo de 30</option>
                            <option value="below_sma200">Abaixo da SMA200</option>
                            <option value="volume_spike">Pico de volume (+200%)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">Notas (opcional)</label>
                        <textarea id="alert-notes" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none" rows="2" placeholder="Ex: Comprar quando atingir este preço com RSI oversold..."></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-2 pt-4">
                    <button onclick="App.Alerts.closeModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg">Cancelar</button>
                    <button onclick="App.Alerts.createAlert()" class="px-4 py-2 bg-holder-accumulation hover:bg-green-500 text-white rounded-lg">Salvar Alerta DCA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configurações HOLDER -->
    <div id="settingsModal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md sm:max-w-2xl overflow-hidden mx-2">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Configurações HOLDER</h3>
                <button onclick="App.Settings.closeModal()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-4 sm:p-6 space-y-4 max-h-96 overflow-y-auto">
                <div class="text-white text-sm mb-2">Estratégia de Investimento:</div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-4">
                    <button class="p-3 bg-dark-800 border border-gray-700 rounded-lg text-center hover:border-holder-accumulation" onclick="App.Settings.setStrategy('conservative')">
                        <div class="text-holder-accumulation font-bold">Conservadora</div>
                        <div class="text-xs text-gray-500">70% BTC/ETH</div>
                    </button>
                    <button class="p-3 bg-dark-800 border border-holder-accumulation rounded-lg text-center">
                        <div class="text-holder-accumulation font-bold">Balanceada</div>
                        <div class="text-xs text-gray-500">50% BTC/ETH</div>
                    </button>
                    <button class="p-3 bg-dark-800 border border-gray-700 rounded-lg text-center hover:border-holder-accumulation" onclick="App.Settings.setStrategy('growth')">
                        <div class="text-holder-accumulation font-bold">Crescimento</div>
                        <div class="text-xs text-gray-500">30% BTC/ETH</div>
                    </button>
                </div>
                
                <div class="text-white mb-2">Gerenciar Ativos:</div>
                <div id="settings-tokens-list" class="flex flex-wrap gap-2 mt-2 mb-4">
                    <!-- Ativos serão renderizados aqui -->
                </div>
                
                <div class="text-white mb-2">Adicionar Ativos em Lote (apelido:SYMBOL):</div>
                <textarea id="batch-tokens" class="w-full bg-dark-800 border border-gray-700 rounded-lg px-3 py-2 text-white focus:border-holder-accumulation outline-none" rows="4" placeholder="Exemplo:&#10;Bitcoin:BTC&#10;Ethereum:ETH&#10;Cardano:ADA"></textarea>
                <div class="flex gap-2">
                    <button onclick="App.Token.addBatch()" class="px-4 py-2 bg-holder-accumulation hover:bg-green-500 text-white rounded-lg">Adicionar Ativos</button>
                    <button onclick="App.Token.removeSelected()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg">Excluir Selecionados</button>
                </div>
            </div>
            <div class="flex justify-end gap-2 pt-4 p-4">
                <button onclick="App.Settings.save()" class="px-4 py-2 bg-holder-accumulation hover:bg-green-500 text-white rounded-lg">Salvar Configurações</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Exportação -->
    <div id="export-modal" class="fixed inset-0 z-[120] hidden modal-overlay flex items-center justify-center p-4">
        <div class="bg-dark-900 border border-gray-700 rounded-xl shadow-2xl w-full max-w-md overflow-hidden mx-2">
            <div class="bg-dark-800 p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-white font-bold">Exportar Relatório</h3>
                <button onclick="App.Export.closeModal()" class="text-gray-500 hover:text-white p-2"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <button onclick="App.Export.gen('xlsx')" class="w-full bg-holder-accumulation hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow-lg">Baixar Relatório .XLSX</button>
                <button onclick="App.Export.gen('portfolio')" class="w-full bg-holder-holding hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg">Exportar Portfólio Ideal</button>
            </div>
        </div>
    </div>

    <!-- Template do Card HOLDER -->
    <template id="card-template">
        <div class="card glass rounded-xl overflow-hidden hover:border-gray-500 transition-all duration-300 card-enter flex flex-col group shadow-lg holder-phase-holding" data-symbol="">
            <button class="btn-remove absolute top-2 right-2 text-gray-600 hover:text-red-500 z-20 opacity-0 group-hover:opacity-100 p-2 transition-opacity bg-dark-900/80 rounded-full backdrop-blur-sm" title="Remover"><i class="fa-solid fa-times"></i></button>
            
            <div class="p-4 cursor-pointer card-header relative z-10 bg-gradient-to-b from-dark-800/40 to-transparent" onclick="App.UI.toggleCard(this)">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-3">
                        <div class="relative w-10 h-10">
                            <div class="score-badge w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-black border border-white shadow-sm cursor-help" data-tip="m_score">--</div>
                        </div>
                        <div>
                            <h3 class="font-bold text-white text-lg symbol-ticker leading-none" data-tip="col_ticker">BTC</h3>
                            <div class="text-[9px] text-gray-400 symbol-name">Bitcoin</div>
                            <span class="phase-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded bg-gray-800 text-gray-500 mt-1 inline-block cursor-help" data-tip="m_phase">Fase: --</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-mono font-bold text-white price-display cursor-help" data-tip="m_price">$0.00</div>
                        <div class="text-xs font-bold percent-display text-gray-500 cursor-help" data-tip="m_change_30d">0.00% (30d)</div>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-1 text-[9px] font-mono text-gray-400 pt-2 border-t border-gray-800/50">
                    <div class="text-center cursor-help" data-tip="m_sma200">SMA200: <span class="metric-sma200 text-white">--</span></div>
                    <div class="text-center cursor-help" data-tip="m_historical">Histórico: <span class="metric-historical text-white">--</span></div>
                    <div class="text-center cursor-help" data-tip="m_risk">Risco: <span class="metric-risk text-white">--</span></div>
                </div>
            </div>

            <div class="card-body hidden border-t border-gray-800 bg-dark-900 relative z-20 p-4">
                <!-- Banda Histórica de Preço -->
                <div class="relative h-8 w-full bg-dark-800 rounded border border-gray-800 mb-4 overflow-hidden">
                    <div class="historical-band band-0-20"></div>
                    <div class="historical-band band-20-40"></div>
                    <div class="historical-band band-40-60"></div>
                    <div class="historical-band band-60-80"></div>
                    <div class="historical-band band-80-100"></div>
                    <div class="absolute top-0 left-0 w-full h-full flex items-center justify-center">
                        <span class="text-xs font-bold z-10">Posição Histórica: <span class="historical-position">--</span>%</span>
                    </div>
                    <div class="absolute bottom-0 left-0 h-full w-1 bg-white z-10 historical-indicator" style="left: 50%;"></div>
                </div>
                
                <div class="h-40 sm:h-48 w-full bg-black rounded border border-gray-800 chart-container mb-4 cursor-help" data-tip="m_chart"></div>
                
                <div class="space-y-4">
                    <!-- Análise de Valuation -->
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1">Valuation</h5>
                        <div class="space-y-1 text-[10px] font-mono">
                            <div class="flex justify-between cursor-help" data-tip="val_ath"><span class="text-gray-600">Máx. Histórico:</span><span class="val-ath text-red-400">--</span></div>
                            <div class="flex justify-between cursor-help" data-tip="val_atl"><span class="text-gray-600">Mín. Histórico:</span><span class="val-atl text-green-400">--</span></div>
                            <div class="flex justify-between cursor-help" data-tip="val_avg"><span class="text-gray-600">Média 2 anos:</span><span class="val-avg text-blue-400">--</span></div>
                            <div class="flex justify-between cursor-help" data-tip="val_discount"><span class="text-gray-600">Desconto da Média:</span><span class="val-discount text-green-400">--</span></div>
                        </div>
                    </div>
                    
                    <!-- Zonas de Preço -->
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1 cursor-help" data-tip="zones_intro">Zonas de Preço HOLDER</h5>
                        <div class="space-y-1 text-[10px] font-mono">
                            <div class="flex justify-between"><span class="text-gray-600">Acumulação Agressiva:</span><span class="zone-agg text-green-400">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Acumulação Moderada:</span><span class="zone-mod text-green-300">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Preço Justo:</span><span class="zone-fair text-blue-400">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Realização Parcial:</span><span class="zone-partial text-yellow-400">--</span></div>
                            <div class="flex justify-between"><span class="text-gray-600">Realização Total:</span><span class="zone-full text-red-400">--</span></div>
                        </div>
                    </div>
                    
                    <!-- Alertas DCA -->
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1">Alertas DCA</h5>
                        <div class="alert-list text-[10px] text-gray-300 space-y-1 max-h-20 overflow-y-auto"></div>
                        <button class="w-full bg-holder-dca_zone/30 text-holder-dca_zone text-[9px] border border-holder-dca_zone rounded py-1 mt-1 hover:bg-holder-dca_zone/50 transition-colors" onclick="App.Alerts.openForCard(this)">+ Alerta DCA</button>
                    </div>
                    
                    <!-- Análise Holder -->
                    <div class="bg-dark-950 p-2 rounded border border-gray-800">
                        <h5 class="text-[9px] text-gray-500 uppercase font-bold mb-1 border-b border-gray-800 pb-1 cursor-help" data-tip="analysis_holder">Análise HOLDER</h5>
                        <div class="analysis-holder-content text-[10px] text-gray-300 space-y-2">
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_phase">Fase do Ciclo:</span>
                                <span class="analysis-phase">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_recommendation">Recomendação:</span>
                                <span class="analysis-recommendation">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_horizon">Horizonte:</span>
                                <span class="analysis-horizon">--</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="cursor-help" data-tip="analysis_confidence">Confiança:</span>
                                <span class="analysis-confidence">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        const BINANCE_REST = "https://api.binance.com/api/v3/klines";
        const BINANCE_WS = "wss://stream.binance.com:9443/ws/!ticker@arr";

        const App = {
            State: {
                tokens: JSON.parse(localStorage.getItem('holder_tokens')) || [
                    {symbol: 'BTCUSDT', name: 'Bitcoin'},
                    {symbol: 'ETHUSDT', name: 'Ethereum'},
                    {symbol: 'BNBUSDT', name: 'Binance Coin'},
                    {symbol: 'SOLUSDT', name: 'Solana'},
                    {symbol: 'ADAUSDT', name: 'Cardano'},
                    {symbol: 'DOTUSDT', name: 'Polkadot'}
                ],
                alerts: JSON.parse(localStorage.getItem('holder_alerts')) || [],
                historicalData: JSON.parse(localStorage.getItem('holder_historical')) || {},
                ws: null, 
                charts: {}, 
                activeCard: null,
                settings: JSON.parse(localStorage.getItem('holder_settings')) || { 
                    strategy: 'balanced',
                    autoRefresh: true, 
                    refreshInterval: 120, // 2 minutos para holders
                    alertSounds: true, 
                    dcaEnabled: true,
                    riskProfile: 'moderate'
                },
                marketData: {}, 
                ohlcData: {}, 
                indicatorsData: {}, 
                fiboData: {},
                timeframes: ["1d","1w","1M"], // Apenas timeframes longos para holders
                portfolioStrategy: 'balanced'
            },

            // 1. BIBLIOTECA HOLDER - Conteúdo educacional específico para holders
            Library: {
                'holder_accumulation_title': { 
                    title: "Zonas de Acumulação", 
                    what: "Ativos que estão em níveis históricos favoráveis para acumulação de longo prazo. Baseado em desconto da média histórica, RSI baixo e posição em ciclos anteriores.", 
                    interp: "Foque nestes ativos para DCA (Dollar Cost Averaging). Acumule gradualmente nestes níveis.", 
                    tip: "A melhor estratégia é acumular em etapas, nunca tudo de uma vez.",
                    example: "BTC a 40% de desconto da média de 2 anos"
                },
                'holder_holding_title': { 
                    title: "Manter Posição", 
                    what: "Ativos em posição neutra ou em tendência de longo prazo favorável. Não é hora de acumular agressivamente nem de realizar lucros.", 
                    interp: "Mantenha suas posições, rebalanceie se necessário, mas não faça movimentos bruscos.", 
                    tip: "Paciência é a maior virtude do holder.",
                    example: "ETH próximo à SMA200 com tendência positiva"
                },
                'holder_profit_title': { 
                    title: "Realizar Lucros", 
                    what: "Ativos que atingiram níveis de sobrecompra históricos ou estão próximos de máximas. Considere realizar lucros parciais.", 
                    interp: "Realize 20-30% da posição para garantir lucros e reduzir risco.", 
                    tip: "Nunca venda tudo de uma vez. Faça em etapas.",
                    example: "SOL a 80% do máximo histórico"
                },
                'holder_alerts': { 
                    title: "Alertas de Acumulação (DCA)", 
                    what: "Sistema de alertas específico para estratégia de Dollar Cost Averaging. Configure preços-alvo para acumulação gradual.", 
                    interp: "Use para automatizar sua estratégia de compras periódicas.", 
                    tip: "Configure alertas em múltiplos níveis para acumular em degraus.",
                    example: "Comprar BTC a $40k, $38k, $35k"
                },
                'portfolio_title': { 
                    title: "Portfólio Holder Recomendado", 
                    what: "Alocação ideal de ativos baseada em fundamentos, histórico e análise de risco. Atualizada dinamicamente conforme condições de mercado.", 
                    interp: "Use como guia para construir seu portfólio de longo prazo.", 
                    tip: "Diversifique, mas mantenha foco em ativos com fundamentos sólidos.",
                    example: "60% BTC, 20% ETH, 20% Altcoins selecionadas"
                },
                'val_ath': { 
                    title: "Máximo Histórico (ATH)", 
                    what: "Preço mais alto já atingido pelo ativo. Referência importante para entender potencial de alta.", 
                    interp: "Ativos muito abaixo do ATH podem ter mais espaço para valorização.", 
                    tip: "Compre ativos com >50% de desconto do ATH para maior margem de segurança.",
                    example: "BTC ATH: $69k | Atual: $45k (35% abaixo)"
                },
                'val_atl': { 
                    title: "Mínimo Histórico (ATL)", 
                    what: "Preço mais baixo já atingido pelo ativo. Referência para suportes históricos.", 
                    interp: "Ativos próximos do ATL podem representar oportunidades únicas.", 
                    tip: "Compre próximo ao ATL apenas se os fundamentos permanecerem sólidos.",
                    example: "BTC ATL: $3k | Atual: $45k (15x acima)"
                },
                'val_avg': { 
                    title: "Média Histórica (2 anos)", 
                    what: "Preço médio dos últimos 2 anos. Indicador de valuation justo.", 
                    interp: "Preço abaixo da média = oportunidade. Acima da média = cautela.", 
                    tip: "Acumule quando estiver 20-30% abaixo da média histórica.",
                    example: "Média 2 anos: $38k | Atual: $45k (18% acima)"
                },
                'val_discount': { 
                    title: "Desconto da Média Histórica", 
                    what: "Percentual que o preço atual está abaixo da média histórica de 2 anos.", 
                    interp: "Quanto maior o desconto, maior a oportunidade de acumulação.", 
                    tip: "Busque descontos >20% para acumulação agressiva.",
                    example: "Desconto de 25% = preço 25% abaixo da média"
                },
                'zones_intro': { 
                    title: "Zonas de Preço HOLDER", 
                    what: "Divisão do espectro de preço em zonas estratégicas para holders. Baseado em percentis históricos.", 
                    interp: "Cada zona representa uma ação diferente: acumular, manter ou realizar.", 
                    tip: "Tenha um plano para cada zona e siga-o disciplinadamente.",
                    factors: "Baseado em histórico de 2+ anos e análise de distribuição",
                    example: "Zona de acumulação: 0-30% do range histórico"
                },
                'analysis_holder': { 
                    title: "Análise HOLDER Completa", 
                    what: "Avaliação multidimensional específica para investidores de longo prazo. Combina valuation, ciclos, fundamentos e técnico.", 
                    interp: "Fornece recomendações claras de ação baseada no horizonte de 1-3 anos.", 
                    tip: "Foque na recomendação e no horizonte, não em flutuações diárias.",
                    factors: "Score composto: Valuation 40%, Ciclos 30%, Fundamentos 20%, Técnico 10%",
                    example: "Recomendação: ACUMULAR | Horizonte: 18-24 meses | Confiança: Alta"
                },
                'analysis_phase': { 
                    title: "Fase do Ciclo de Mercado", 
                    what: "Identificação da fase atual no ciclo de mercado típico de criptomoedas (acumulação, tendência de alta, distribuição, tendência de baixa).", 
                    interp: "Cada fase requer estratégia diferente. Acumule na fase de acumulação.", 
                    tip: "Ciclos duram tipicamente 3-4 anos. Posicione-se no início.",
                    example: "Fase: Acumulação | Próxima fase: Tendência de alta"
                },
                'analysis_horizon': { 
                    title: "Horizonte de Investimento Recomendado", 
                    what: "Período de tempo ideal para manter o ativo baseado na análise atual.", 
                    interp: "Horizontes mais longos geralmente oferecem maior probabilidade de retorno positivo.", 
                    tip: "Só invista o que não precisa por pelo menos o horizonte recomendado.",
                    example: "Horizonte: 18-24 meses para retorno de 50-100%"
                },
                'analysis_confidence': { 
                    title: "Nível de Confiança", 
                    what: "Medida de certeza na análise baseada na qualidade e quantidade de dados disponíveis.", 
                    interp: "Alta confiança = maior probabilidade de acerto. Baixa confiança = maior cautela necessária.", 
                    tip: "Ações com alta confiança merecem maior alocação de capital.",
                    example: "Confiança: Alta (dados consistentes de múltiplas fontes)"
                },
                'm_sma200': { 
                    title: "SMA200 - Média de 200 Dias", 
                    what: "Indicador de tendência de longo prazo mais importante. Preço acima = tendência de alta, abaixo = tendência de baixa.", 
                    interp: "Para holders, comprar abaixo da SMA200 oferece melhor risco/retorno.", 
                    tip: "Acumule quando o preço estiver 10-20% abaixo da SMA200.",
                    example: "SMA200: $42k | Preço: $45k (7% acima)"
                },
                'm_historical': { 
                    title: "Posição Histórica", 
                    what: "Percentil do preço atual em relação a todo o histórico disponível (últimos 2-4 anos).", 
                    interp: "0% = mínimo histórico, 100% = máximo histórico. 30-50% = zona neutra.", 
                    tip: "Acumule agressivamente abaixo de 30%. Realize lucros acima de 70%.",
                    example: "Posição: 45% (meio do range histórico)"
                },
                'm_risk': { 
                    title: "Perfil de Risco", 
                    what: "Avaliação de risco baseada em volatilidade, liquidez e fundamentos.", 
                    interp: "Baixo risco = ativos estabelecidos (BTC, ETH). Alto risco = altcoins menores.", 
                    tip: "Aloque de acordo com sua tolerância a risco.",
                    example: "Risco: Moderado (altcoin de grande capitalização)"
                },
                'm_phase': { 
                    title: "Fase HOLDER Atual", 
                    what: "Classificação do ativo nas fases da estratégia holder: Acumulação, Manter, Realizar Lucros.", 
                    interp: "Guia suas ações: acumular, manter ou realizar.", 
                    tip: "Siga a fase recomendada com disciplina.",
                    example: "Fase: Acumulação | Ação: Comprar em etapas"
                },
                'm_score': { 
                    title: "Score HOLDER 2.0", 
                    what: "Pontuação de 0-100 específica para holders. Combina valuation, ciclos, fundamentos e análise técnica de longo prazo.", 
                    interp: "70+ = acumular, 40-70 = manter, abaixo de 40 = considerar realizar lucros.", 
                    tip: "Foque em ativos com score >70 para novas posições.",
                    example: "Score 85/100 = oportunidade excepcional de acumulação"
                },
                'm_chart': { 
                    title: "Gráfico de Longo Prazo", 
                    what: "Visualização do histórico de preços com foco em tendências de médio/longo prazo (dias e semanas).", 
                    interp: "Identifique suportes e resistências importantes para horizontes de 6+ meses.", 
                    tip: "Ignore o ruído diário. Foque nas tendências semanais e mensais.",
                    example: "Gráfico semanal mostrando suporte em $40k e resistência em $55k"
                },
                'm_price': { 
                    title: "Preço Atual (USDT)", 
                    what: "Cotação atual em tempo real. Referência principal para todas as análises.", 
                    interp: "Compare sempre com as zonas de preço holder e valuation histórico.", 
                    tip: "Preste mais atenção à posição histórica do que ao preço absoluto.",
                    example: "Preço atual: $45,230.50"
                },
                'm_change_30d': { 
                    title: "Variação 30 Dias", 
                    what: "Performance do ativo no último mês. Métrica relevante para holders (não 24h).", 
                    interp: "Alta consistente em 30d pode indicar início de tendência.", 
                    tip: "Ignore variações diárias. Foque em tendências mensais.",
                    example: "+12.5% nos últimos 30 dias = tendência positiva"
                }
            },

            // 2. CORE ENGINE HOLDER
            Core: {
                init: async () => {
                    App.UI.tooltips();
                    await App.Core.startWebSocket();
                    await App.Core.preloadAllOHLC();
                    await App.Core.loadHistoricalData(); // Carregar dados históricos
                    App.UI.grid(); 
                    App.UI.tables(); 
                    App.Portfolio.generate();
                    
                    setInterval(() => { 
                        let e = document.getElementById('countdown'), v = +e.innerText.replace('s',''); 
                        e.innerText = (v <= 0 ? App.State.settings.refreshInterval : v - 1) + 's'; 
                        if (v <= 0 && App.State.settings.autoRefresh) App.Core.refreshData(); 
                    }, 1000);
                    
                    setInterval(() => {
                        App.State.tokens.forEach(token => {
                            App.State.timeframes.forEach(tf => { 
                                App.Core.incrementalUpdateOHLC(token.symbol, tf); 
                            });
                        });
                    }, 30000); // 30 segundos para holders (não precisa ser tão frequente)
                    
                    setInterval(() => App.Alerts.checkAllAlerts(), 10000);

                    // Mobile menu toggle
                    document.getElementById('mobile-menu-toggle').addEventListener('click', function() {
                        const controls = document.getElementById('header-controls');
                        controls.classList.toggle('hidden');
                        controls.classList.toggle('flex');
                    });

                    // Inicializar alertas
                    App.Alerts.renderAlertsPanel();
                    
                    document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
                    
                    // Estratégia de portfólio
                    document.getElementById('portfolio-strategy').addEventListener('change', function() {
                        App.State.portfolioStrategy = this.value;
                        App.Portfolio.generate();
                    });
                },
                
                refreshData: () => { 
                    App.Core.preloadAllOHLC(); 
                    document.getElementById('last-update').innerText = new Date().toLocaleTimeString(); 
                },
                
                startWebSocket: function() {
                    const ws = new WebSocket(BINANCE_WS);
                    ws.onopen = () => { console.log("🟢 WebSocket conectado."); };
                    ws.onerror = () => { setTimeout(App.Core.startWebSocket, 5000); };
                    ws.onclose = () => { setTimeout(App.Core.startWebSocket, 5000); };
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        data.forEach(t => {
                            const symbol = t.s.toUpperCase();
                            const token = App.State.tokens.find(tok => tok.symbol === symbol);
                            if (!token) return;
                            
                            App.State.marketData[symbol.toLowerCase()] = { 
                                symbol: symbol.toLowerCase(), 
                                lastPrice: parseFloat(t.c), 
                                priceChangePercent: parseFloat(t.P), 
                                highPrice: parseFloat(t.h), 
                                lowPrice: parseFloat(t.l), 
                                volume: parseFloat(t.v),
                                quoteVolume: parseFloat(t.q)
                            };
                            App.UI.updateTokenCard(symbol);
                            App.Alerts.checkAlerts(symbol, parseFloat(t.c));
                        });
                    };
                    App.State.ws = ws;
                },
                
                fetchOHLC: async function(symbol, interval = "1d", limit = 500) {
                    try {
                        const r = await fetch(`${BINANCE_REST}?symbol=${symbol.toUpperCase()}&interval=${interval}&limit=${limit}`);
                        const j = await r.json();
                        return j.map(k => ({ 
                            time: k[0], 
                            open: parseFloat(k[1]), 
                            high: parseFloat(k[2]), 
                            low: parseFloat(k[3]), 
                            close: parseFloat(k[4]), 
                            volume: parseFloat(k[5]) 
                        }));
                    } catch (err) { 
                        console.error(`Erro ao buscar OHLC para ${symbol}:`, err);
                        return []; 
                    }
                },
                
                loadAllOHLC: async function(symbol) {
                    if (!App.State.ohlcData[symbol]) App.State.ohlcData[symbol] = {};
                    for (let tf of App.State.timeframes) { 
                        App.State.ohlcData[symbol][tf] = await App.Core.fetchOHLC(symbol, tf, 500); 
                    }
                },
                
                preloadAllOHLC: async function() {
                    for (let token of App.State.tokens) {
                        await App.Core.loadAllOHLC(token.symbol.toUpperCase());
                    }
                    App.State.tokens.forEach(token => { 
                        App.State.timeframes.forEach(tf => { 
                            App.Indicators.updateIndicators(token.symbol.toLowerCase(), tf); 
                        }); 
                    });
                },
                
                incrementalUpdateOHLC: async function(symbol, tf) {
                    const url = `${BINANCE_REST}?symbol=${symbol.toUpperCase()}&interval=${tf}&limit=3`;
                    try {
                        const response = await fetch(url); 
                        const raw = await response.json();
                        const newCandles = raw.map(k => ({ 
                            time: k[0], 
                            open: parseFloat(k[1]), 
                            high: parseFloat(k[2]), 
                            low: parseFloat(k[3]), 
                            close: parseFloat(k[4]), 
                            volume: parseFloat(k[5]) 
                        }));
                        
                        if (!App.State.ohlcData[symbol] || !App.State.ohlcData[symbol][tf]) { 
                            App.State.ohlcData[symbol] = App.State.ohlcData[symbol] || {}; 
                            App.State.ohlcData[symbol][tf] = newCandles; 
                        } else { 
                            const existing = App.State.ohlcData[symbol][tf]; 
                            newCandles.forEach(c => { 
                                const idx = existing.findIndex(x => x.time === c.time); 
                                if (idx === -1) existing.push(c); 
                                else existing[idx] = c; 
                            }); 
                            existing.sort((a, b) => a.time - b.time); 
                        }
                        App.Core.triggerOHLCUpdate(symbol.toLowerCase(), tf);
                        App.Indicators.updateIndicators(symbol.toLowerCase(), tf);
                    } catch (err) {
                        console.error(`Erro incremental update ${symbol} ${tf}:`, err);
                    }
                },
                
                getOHLC: (symbol, tf) => (App.State.ohlcData[symbol.toUpperCase()] || {})[tf] || [],
                getCloseArray: (symbol, tf) => App.Core.getOHLC(symbol, tf).map(c => c.close),
                
                // Carregar dados históricos para análise de valuation
                loadHistoricalData: async function() {
                    if (Object.keys(App.State.historicalData).length > 0) return;
                    
                    // Para cada token, calcular estatísticas históricas
                    for (let token of App.State.tokens) {
                        const symbol = token.symbol;
                        const ohlc1d = App.Core.getOHLC(symbol, "1d");
                        if (ohlc1d.length > 0) {
                            const closes = ohlc1d.map(c => c.close);
                            const highs = ohlc1d.map(c => c.high);
                            const lows = ohlc1d.map(c => c.low);
                            
                            App.State.historicalData[symbol] = {
                                ath: Math.max(...highs),
                                atl: Math.min(...lows),
                                avg2y: closes.length >= 730 ? 
                                    closes.slice(-730).reduce((a, b) => a + b, 0) / 730 :
                                    closes.reduce((a, b) => a + b, 0) / closes.length,
                                currentPercentile: 0,
                                volatility: App.Indicators.calculateHistoricalVolatility(closes)
                            };
                        }
                    }
                    
                    localStorage.setItem('holder_historical', JSON.stringify(App.State.historicalData));
                },
                
                ohlcCallbacks: [],
                onOHLCUpdate: (cb) => App.Core.ohlcCallbacks.push(cb),
                triggerOHLCUpdate: (symbol, tf) => App.Core.ohlcCallbacks.forEach(cb => cb(symbol, tf)),
                
                calculatePriceChange: (symbol, period) => {
                    const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice;
                    if (!currentPrice || currentPrice === 0) return 0;
                    
                    let pastPrice = 0;
                    let ohlc;
                    
                    try {
                        switch(period) {
                            case "7d":
                                ohlc = App.Core.getOHLC(symbol, "1d");
                                if (ohlc && ohlc.length >= 7) {
                                    pastPrice = ohlc[ohlc.length - 7].close;
                                }
                                break;
                                
                            case "30d":
                                ohlc = App.Core.getOHLC(symbol, "1d");
                                if (ohlc && ohlc.length >= 30) {
                                    pastPrice = ohlc[ohlc.length - 30].close;
                                }
                                break;
                                
                            case "90d":
                                ohlc = App.Core.getOHLC(symbol, "1d");
                                if (ohlc && ohlc.length >= 90) {
                                    pastPrice = ohlc[ohlc.length - 90].close;
                                }
                                break;
                                
                            default:
                                return 0;
                        }
                        
                        if (!pastPrice || pastPrice === 0) {
                            console.warn(`Preço passado inválido para ${symbol} ${period}`);
                            return 0;
                        }
                        
                        const change = ((currentPrice - pastPrice) / pastPrice) * 100;
                        
                        if (Math.abs(change) > 500) {
                            console.warn(`Variação extrema detectada para ${symbol} ${period}: ${change}%`);
                            return 0;
                        }
                        
                        return change;
                        
                    } catch (error) {
                        console.error(`Erro em calculatePriceChange para ${symbol} ${period}:`, error);
                        return 0;
                    }
                }
            },

            // 3. INDICATORS HOLDER
            Indicators: {
                // Calcular SMA para qualquer período
                calculateSMA: (closes, period) => {
                    if (closes.length < period) return null;
                    const sum = closes.slice(-period).reduce((a, b) => a + b, 0);
                    return sum / period;
                },
                
                // Calcular EMA
                calculateEMA: (closes, period) => {
                    if (closes.length < period) return null;
                    const k = 2 / (period + 1);
                    let ema = closes.slice(0, period).reduce((a, b) => a + b, 0) / period;
                    
                    for (let i = period; i < closes.length; i++) {
                        ema = (closes[i] - ema) * k + ema;
                    }
                    return ema;
                },
                
                // Calcular volatilidade histórica (desvio padrão dos retornos)
                calculateHistoricalVolatility: (closes, period = 30) => {
                    if (closes.length < period + 1) return 0;
                    
                    const returns = [];
                    for (let i = 1; i < closes.length; i++) {
                        returns.push((closes[i] - closes[i-1]) / closes[i-1]);
                    }
                    
                    const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
                    const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
                    return Math.sqrt(variance) * Math.sqrt(365); // Anualizada
                },
                
                // Calcular percentil histórico
                calculateHistoricalPercentile: (currentPrice, historicalCloses) => {
                    if (historicalCloses.length === 0) return 50;
                    
                    const sorted = [...historicalCloses].sort((a, b) => a - b);
                    const countBelow = sorted.filter(price => price < currentPrice).length;
                    return (countBelow / sorted.length) * 100;
                },
                
                // Calcular zonas de preço baseadas em percentis históricos
                calculatePriceZones: (historicalCloses) => {
                    if (historicalCloses.length < 100) return null;
                    
                    const sorted = [...historicalCloses].sort((a, b) => a - b);
                    return {
                        zone1: sorted[Math.floor(sorted.length * 0.1)], // 10% (acumulação agressiva)
                        zone2: sorted[Math.floor(sorted.length * 0.3)], // 30% (acumulação moderada)
                        zone3: sorted[Math.floor(sorted.length * 0.5)], // 50% (preço justo)
                        zone4: sorted[Math.floor(sorted.length * 0.7)], // 70% (realização parcial)
                        zone5: sorted[Math.floor(sorted.length * 0.9)]  // 90% (realização total)
                    };
                },
                
                // Determinar fase holder baseada em múltiplos fatores
                determineHolderPhase: (ind, historical) => {
                    if (!ind || !historical) return 'holding';
                    
                    const currentPrice = ind.currentPrice;
                    const percentile = ind.historicalPercentile;
                    const discountFromAvg = historical.avg2y ? ((historical.avg2y - currentPrice) / historical.avg2y) * 100 : 0;
                    
                    if (percentile < 30 || discountFromAvg > 20) {
                        return 'accumulation';
                    } else if (percentile > 70) {
                        return 'profit_taking';
                    } else {
                        return 'holding';
                    }
                },
                
                // Calcular score holder 2.0
                calculateHolderScore: (ind, historical) => {
                    let score = 50;
                    
                    // 1. Valuation (40% do score)
                    if (historical) {
                        const discount = historical.avg2y ? ((historical.avg2y - ind.currentPrice) / historical.avg2y) * 100 : 0;
                        
                        if (discount > 30) score += 40;
                        else if (discount > 20) score += 30;
                        else if (discount > 10) score += 20;
                        else if (discount > 0) score += 10;
                        else if (discount < -20) score -= 20;
                        else if (discount < -10) score -= 10;
                    }
                    
                    // 2. Posição histórica (30% do score)
                    const percentile = ind.historicalPercentile || 50;
                    if (percentile < 20) score += 30;
                    else if (percentile < 35) score += 20;
                    else if (percentile < 50) score += 10;
                    else if (percentile > 80) score -= 20;
                    else if (percentile > 65) score -= 10;
                    
                    // 3. Tendência de longo prazo (20% do score)
                    if (ind.sma200 && ind.currentPrice) {
                        const sma200Dist = ((ind.currentPrice - ind.sma200) / ind.sma200) * 100;
                        if (sma200Dist < -15) score += 20;
                        else if (sma200Dist < 0) score += 10;
                        else if (sma200Dist > 30) score -= 10;
                    }
                    
                    // 4. RSI longo prazo (10% do score)
                    if (ind.rsi) {
                        if (ind.rsi < 30) score += 10;
                        else if (ind.rsi > 70) score -= 5;
                    }
                    
                    // Ajustar para 0-100
                    score = Math.max(0, Math.min(100, score));
                    return Math.round(score);
                },
                
                // Atualizar todos os indicadores
                updateIndicators: (symbol, tf) => {
                    const ohlc = App.Core.getOHLC(symbol, tf);
                    const closes = ohlc.map(c => c.close);
                    
                    if (!App.State.indicatorsData[symbol]) App.State.indicatorsData[symbol] = {};
                    if (!App.State.indicatorsData[symbol][tf]) App.State.indicatorsData[symbol][tf] = {};
                    
                    const ind = App.State.indicatorsData[symbol][tf];
                    const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || closes[closes.length - 1];
                    
                    // Preço atual
                    ind.currentPrice = currentPrice;
                    
                    // Variações de preço (longo prazo apenas)
                    ind.ch7d = App.Core.calculatePriceChange(symbol, "7d");
                    ind.ch30d = App.Core.calculatePriceChange(symbol, "30d");
                    ind.ch90d = App.Core.calculatePriceChange(symbol, "90d");
                    
                    // Médias móveis importantes para holders
                    ind.sma200 = App.Indicators.calculateSMA(closes, 200);
                    ind.ema200 = App.Indicators.calculateEMA(closes, 200);
                    ind.sma50 = App.Indicators.calculateSMA(closes, 50);
                    
                    // RSI (14 períodos)
                    ind.rsi = App.Indicators.calcRSI(closes);
                    
                    // Análise histórica
                    const historical = App.State.historicalData[symbol.toUpperCase()];
                    if (historical) {
                        ind.historicalPercentile = App.Indicators.calculateHistoricalPercentile(currentPrice, closes);
                        ind.priceZones = App.Indicators.calculatePriceZones(closes);
                    }
                    
                    // Calcular fase holder
                    ind.holderPhase = App.Indicators.determineHolderPhase(ind, historical);
                    
                    // Calcular score holder
                    ind.holderScore = App.Indicators.calculateHolderScore(ind, historical);
                    
                    // Volatilidade
                    ind.volatility = App.Indicators.calculateHistoricalVolatility(closes, 30);
                    
                    // Classificação de risco baseada em volatilidade e capitalização
                    if (ind.volatility < 0.7) ind.riskLevel = 'low';
                    else if (ind.volatility < 1.2) ind.riskLevel = 'moderate';
                    else ind.riskLevel = 'high';
                },
                
                // RSI (mantido para compatibilidade)
                calcRSI: (closes, period = 14) => {
                    if (closes.length < period + 1) return null;
                    
                    let gains = [];
                    let losses = [];
                    
                    for (let i = 1; i < closes.length; i++) {
                        const change = closes[i] - closes[i - 1];
                        gains.push(change > 0 ? change : 0);
                        losses.push(change < 0 ? -change : 0);
                    }
                    
                    const avgGain = gains.slice(-period).reduce((a, b) => a + b, 0) / period;
                    const avgLoss = losses.slice(-period).reduce((a, b) => a + b, 0) / period;
                    
                    if (avgLoss === 0) return 100;
                    const rs = avgGain / avgLoss;
                    return 100 - (100 / (1 + rs));
                }
            },

            // 4. PORTFOLIO HOLDER
            Portfolio: {
                // Gerar portfólio recomendado baseado na estratégia
                generate: () => {
                    const strategy = App.State.portfolioStrategy;
                    let allocations = [];
                    
                    // Dados de todos os tokens
                    const allData = App.State.tokens.map(token => {
                        const symbol = token.symbol;
                        const s = symbol.toLowerCase();
                        const i = App.State.indicatorsData[s]?.["1d"] || {};
                        const historical = App.State.historicalData[symbol] || {};
                        const m = App.State.marketData[s] || {};
                        
                        return {
                            symbol: symbol,
                            name: token.name,
                            price: m.lastPrice || 0,
                            holderScore: i.holderScore || 50,
                            holderPhase: i.holderPhase || 'holding',
                            riskLevel: i.riskLevel || 'moderate',
                            marketCap: m.quoteVolume || 0,
                            historical: historical
                        };
                    });
                    
                    // Ordenar por score holder
                    allData.sort((a, b) => b.holderScore - a.holderScore);
                    
                    // Definir alocações baseado na estratégia
                    let totalAllocation = 0;
                    
                    allData.forEach((token, index) => {
                        let allocation = 0;
                        
                        // Estratégias diferentes
                        switch(strategy) {
                            case 'conservative':
                                if (token.symbol === 'BTCUSDT') allocation = 50;
                                else if (token.symbol === 'ETHUSDT') allocation = 20;
                                else if (index < 4) allocation = 7.5;
                                else allocation = 2.5;
                                break;
                                
                            case 'balanced':
                                if (token.symbol === 'BTCUSDT') allocation = 35;
                                else if (token.symbol === 'ETHUSDT') allocation = 15;
                                else if (index < 6) allocation = 8.33;
                                else allocation = 0;
                                break;
                                
                            case 'growth':
                                if (token.symbol === 'BTCUSDT') allocation = 20;
                                else if (token.symbol === 'ETHUSDT') allocation = 10;
                                else if (index < 8) allocation = 8.75;
                                else allocation = 0;
                                break;
                        }
                        
                        if (allocation > 0) {
                            allocations.push({
                                ...token,
                                allocation: allocation,
                                idealEntry: token.price * 0.85, // 15% abaixo do atual
                                target1y: token.price * (1 + (token.holderScore / 100)), // Score como % de ganho
                                target2y: token.price * (1 + (token.holderScore / 50)) // Score/50 como % de ganho
                            });
                            totalAllocation += allocation;
                        }
                    });
                    
                    // Normalizar para 100%
                    if (totalAllocation !== 100) {
                        const factor = 100 / totalAllocation;
                        allocations.forEach(a => a.allocation *= factor);
                    }
                    
                    // Renderizar tabela
                    App.Portfolio.render(allocations);
                },
                
                // Renderizar tabela de portfólio
                render: (allocations) => {
                    const tbody = document.getElementById('portfolio-body');
                    tbody.innerHTML = '';
                    
                    allocations.forEach((item, index) => {
                        const phaseColor = item.holderPhase === 'accumulation' ? 'text-green-400' : 
                                          item.holderPhase === 'profit_taking' ? 'text-red-400' : 'text-blue-400';
                        const phaseText = item.holderPhase === 'accumulation' ? 'Acumular' : 
                                         item.holderPhase === 'profit_taking' ? 'Realizar' : 'Manter';
                        
                        const rowClass = item.holderPhase === 'accumulation' ? 'ranking-row-high' : 
                                        item.holderPhase === 'profit_taking' ? 'ranking-row-low' : 'ranking-row-mid';
                        
                        tbody.innerHTML += `
                            <tr class="table-row-hover border-b border-gray-800 cursor-pointer ${rowClass}" onclick="App.UI.toggleCard(document.querySelector('.card[data-symbol=${item.symbol}]'))">
                                <td class="p-3 text-center text-gray-500 font-bold">${index + 1}</td>
                                <td class="p-3 font-bold text-white">
                                    <div>${item.symbol.replace('USDT', '')}</div>
                                    <div class="text-[10px] text-gray-500">${item.name}</div>
                                </td>
                                <td class="p-3 text-center font-bold ${phaseColor}">${phaseText}</td>
                                <td class="p-3 text-center font-mono text-white">${item.allocation.toFixed(1)}%</td>
                                <td class="p-3 text-center font-mono text-green-400">$${item.idealEntry.toFixed(2)}</td>
                                <td class="p-3 text-center font-mono text-blue-400">$${item.target1y.toFixed(2)}</td>
                                <td class="p-3 text-center font-bold ${item.holderScore > 70 ? 'text-green-400' : item.holderScore < 40 ? 'text-red-400' : 'text-blue-400'}">${item.holderScore}/100</td>
                                <td class="p-3 text-right">
                                    <button onclick="App.Alerts.openForSymbol('${item.symbol}')" class="text-holder-accumulation hover:text-green-300 p-1">
                                        <i class="fa-solid fa-bell"></i>
                                    </button>
                                </td>
                            </tr>`;
                    });
                }
            },

            // 5. UI HOLDER
            UI: {
                tooltips: () => {
                    const ov = document.getElementById('metric-tooltip-overlay');
                    const show = (t) => {
                        let d = App.Library[t.dataset.tip];
                        if(!d) return;
                        
                        ov.innerHTML = `
                            <div class="flex-1 min-w-[280px] lg:border-r border-gray-800 lg:pr-6">
                                <h4 class="text-holder-accumulation font-bold text-lg mb-3">${d.title}</h4>
                                <p class="text-sm text-gray-300 leading-relaxed text-justify">${d.what}</p>
                            </div>
                            <div class="flex-1 min-w-[280px] lg:border-r border-gray-800 lg:pr-6 lg:pl-6">
                                <div class="mb-3">
                                    <div class="tip-label">Interpretação</div>
                                    <p class="tip-val text-justify">${d.interp||'-'}</p>
                                </div>
                                ${d.example ? `<div class="mt-3"><div class="tip-label">Exemplo</div><p class="tip-val">${d.example}</p></div>` : ''}
                            </div>
                            <div class="flex-1 min-w-[250px] lg:pl-6">
                                <div class="bg-holder-accumulation/20 border border-holder-accumulation/30 p-4 rounded-lg shadow-inner">
                                    <div class="tip-label text-holder-accumulation">Dica HOLDER</div>
                                    <p class="text-xs text-green-100 italic leading-relaxed">"${d.tip||''}"</p>
                                </div>
                            </div>`;
                        ov.classList.remove('tooltip-hidden'); 
                        ov.classList.add('tooltip-visible');
                    };
                    
                    const hide = () => { 
                        ov.classList.remove('tooltip-visible'); 
                        ov.classList.add('tooltip-hidden'); 
                    };
                    
                    document.body.addEventListener('click', (e) => { 
                        let t = e.target.closest('[data-tip]'); 
                        if(t){ show(t); e.stopPropagation(); } 
                        else if(!e.target.closest('#metric-tooltip-overlay')) hide(); 
                    });
                },
                
                tables: () => {
                    let d = App.UI.getAllTokenData();
                    if(!d.length) return;
                    
                    // Zonas de Acumulação
                    const accumulation = d.filter(x => x.holderPhase === 'accumulation')
                        .sort((a,b) => b.holderScore - a.holderScore);
                    
                    // Manter Posição
                    const holding = d.filter(x => x.holderPhase === 'holding')
                        .sort((a,b) => b.holderScore - a.holderScore);
                    
                    // Realizar Lucros
                    const profit = d.filter(x => x.holderPhase === 'profit_taking')
                        .sort((a,b) => b.holderScore - a.holderScore);
                    
                    // Renderizar tabelas
                    App.UI.renderTable('list-accumulation', accumulation.slice(0,5), 
                        x => x.symbol.replace('USDT',''), 
                        x => `$${x.price.toFixed(2)}`,
                        x => `${x.historicalDiscount?.toFixed(1) || '--'}%`);
                    
                    App.UI.renderTable('list-holding', holding.slice(0,5),
                        x => x.symbol.replace('USDT',''),
                        x => x.sma200 ? `${((x.price - x.sma200) / x.sma200 * 100).toFixed(1)}%` : '--',
                        x => `${x.riskLevel || '--'}`);
                    
                    App.UI.renderTable('list-profit', profit.slice(0,5),
                        x => x.symbol.replace('USDT',''),
                        x => `${x.ch90d?.toFixed(1) || '--'}%`,
                        x => x.historical?.ath ? `${((x.price / x.historical.ath) * 100).toFixed(1)}% ATH` : '--');
                },
                
                renderTable: (id, data, col1Fn, col2Fn, col3Fn) => {
                    const tbody = document.getElementById(id);
                    if (!tbody) return;
                    
                    tbody.innerHTML = data.map(item => `
                        <tr class="hover:bg-white/5 cursor-pointer transition-colors border-b border-gray-800/50" 
                            onclick="App.UI.toggleCard(document.querySelector('.card[data-symbol=${item.symbol}]'))">
                            <td class="p-2 font-bold text-white">${col1Fn(item)}</td>
                            <td class="p-2 text-right font-mono text-gray-400">${col2Fn(item)}</td>
                            <td class="p-2 text-right font-mono ${item.holderPhase === 'accumulation' ? 'text-green-400' : item.holderPhase === 'profit_taking' ? 'text-red-400' : 'text-blue-400'}">${col3Fn(item)}</td>
                        </tr>
                    `).join('');
                },
                
                getAllTokenData: () => {
                    return App.State.tokens.map(token => {
                        const symbol = token.symbol;
                        const s = symbol.toLowerCase();
                        const i = App.State.indicatorsData[s]?.["1d"] || {};
                        const historical = App.State.historicalData[symbol] || {};
                        const m = App.State.marketData[s] || {};
                        
                        return {
                            symbol: symbol,
                            name: token.name,
                            price: m.lastPrice || 0,
                            holderScore: i.holderScore || 50,
                            holderPhase: i.holderPhase || 'holding',
                            historicalPercentile: i.historicalPercentile || 50,
                            sma200: i.sma200,
                            ch90d: i.ch90d,
                            riskLevel: i.riskLevel,
                            historical: historical,
                            historicalDiscount: historical.avg2y ? ((historical.avg2y - (m.lastPrice || 0)) / historical.avg2y) * 100 : 0
                        };
                    });
                },
                
                grid: () => {
                    let g = document.getElementById('cards-grid');
                    g.innerHTML='';
                    App.State.tokens.forEach(token => {
                        let el = document.getElementById('card-template').content.cloneNode(true).querySelector('.card');
                        el.dataset.symbol = token.symbol;
                        el.querySelector('.symbol-ticker').innerText = token.symbol.replace('USDT','');
                        el.querySelector('.symbol-name').innerText = token.name;
                        el.querySelector('.btn-remove').onclick = (e)=>{e.stopPropagation(); App.Token.rem(token.symbol)};
                        g.appendChild(el);
                        App.UI.updateTokenCard(token.symbol);
                        App.Alerts.renderInCard(token.symbol);
                    });
                },
                
                updateTokenCard: (symbol) => {
                    const card = document.querySelector(`.card[data-symbol="${symbol}"]`);
                    if(!card) return;
                    
                    const s = symbol.toLowerCase();
                    const m = App.State.marketData[s];
                    const i = App.State.indicatorsData[s]?.["1d"];
                    const historical = App.State.historicalData[symbol.toUpperCase()];
                    const token = App.State.tokens.find(t => t.symbol === symbol);
                    
                    if(m) {
                        card.querySelector('.price-display').innerText = '$'+m.lastPrice.toFixed(2);
                        card.querySelector('.price-display').dataset.v = m.lastPrice;
                        card.querySelector('.percent-display').innerText = (m.priceChangePercent>0?'+':'')+m.priceChangePercent.toFixed(2)+'% (30d)';
                        card.querySelector('.percent-display').className = `text-xs font-bold percent-display ${m.priceChangePercent>0?'text-green-400':'text-red-400'}`;
                    }
                    
                    if(i) {
                        // Atualizar métricas principais
                        card.querySelector('.metric-sma200').innerText = i.sma200 ? `$${i.sma200.toFixed(2)}` : '--';
                        card.querySelector('.metric-historical').innerText = i.historicalPercentile ? `${i.historicalPercentile.toFixed(0)}%` : '--';
                        card.querySelector('.metric-risk').innerText = i.riskLevel || '--';
                        
                        // Atualizar fase
                        const phaseText = i.holderPhase === 'accumulation' ? 'ACUMULAR' : 
                                         i.holderPhase === 'profit_taking' ? 'REALIZAR' : 'MANTER';
                        const phaseColor = i.holderPhase === 'accumulation' ? 'bg-green-900 text-green-400' : 
                                          i.holderPhase === 'profit_taking' ? 'bg-red-900 text-red-400' : 'bg-blue-900 text-blue-400';
                        card.querySelector('.phase-badge').innerText = `Fase: ${phaseText}`;
                        card.querySelector('.phase-badge').className = `phase-badge text-[8px] font-bold uppercase px-1.5 py-0.5 rounded ${phaseColor} mt-1 inline-block cursor-help`;
                        
                        // Atualizar classe do card baseado na fase
                        card.classList.remove('holder-phase-accumulation', 'holder-phase-holding', 'holder-phase-profit');
                        card.classList.add(`holder-phase-${i.holderPhase}`);
                        
                        // Score Holder
                        const score = i.holderScore || 50;
                        const scoreBadge = card.querySelector('.score-badge');
                        scoreBadge.innerText = score.toFixed(0);
                        scoreBadge.className = `score-badge w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-black border border-white shadow-sm cursor-help ${score>70?'bg-score-high':score<40?'bg-score-low':'bg-score-mid'}`;
                        
                        // Atualizar posição histórica no gráfico de bandas
                        const historicalIndicator = card.querySelector('.historical-indicator');
                        const historicalPosition = card.querySelector('.historical-position');
                        if (historicalIndicator && historicalPosition && i.historicalPercentile) {
                            historicalIndicator.style.left = `${i.historicalPercentile}%`;
                            historicalPosition.innerText = i.historicalPercentile.toFixed(0);
                        }
                        
                        // Atualizar valuation
                        if (historical) {
                            card.querySelector('.val-ath').innerText = `$${historical.ath.toFixed(2)}`;
                            card.querySelector('.val-atl').innerText = `$${historical.atl.toFixed(2)}`;
                            card.querySelector('.val-avg').innerText = `$${historical.avg2y.toFixed(2)}`;
                            
                            const discount = historical.avg2y ? ((historical.avg2y - (m?.lastPrice || 0)) / historical.avg2y) * 100 : 0;
                            card.querySelector('.val-discount').innerText = `${discount.toFixed(1)}%`;
                            card.querySelector('.val-discount').className = `val-discount ${discount > 0 ? 'text-green-400' : 'text-red-400'}`;
                        }
                        
                        // Atualizar zonas de preço
                        if (i.priceZones) {
                            card.querySelector('.zone-agg').innerText = `$${i.priceZones.zone1.toFixed(2)}`;
                            card.querySelector('.zone-mod').innerText = `$${i.priceZones.zone2.toFixed(2)}`;
                            card.querySelector('.zone-fair').innerText = `$${i.priceZones.zone3.toFixed(2)}`;
                            card.querySelector('.zone-partial').innerText = `$${i.priceZones.zone4.toFixed(2)}`;
                            card.querySelector('.zone-full').innerText = `$${i.priceZones.zone5.toFixed(2)}`;
                        }
                        
                        // Atualizar análise holder
                        const analysisContent = card.querySelector('.analysis-holder-content');
                        if (analysisContent) {
                            const horizon = score > 70 ? '18-24 meses' : score < 40 ? '3-6 meses' : '12-18 meses';
                            const confidence = score > 80 ? 'Alta' : score > 60 ? 'Moderada' : 'Baixa';
                            const recommendation = i.holderPhase === 'accumulation' ? 'Acumular' : 
                                                 i.holderPhase === 'profit_taking' ? 'Realizar lucros' : 'Manter posição';
                            
                            analysisContent.innerHTML = `
                                <div class="flex justify-between">
                                    <span class="cursor-help" data-tip="analysis_phase">Fase do Ciclo:</span>
                                    <span class="analysis-phase ${phaseColor.split(' ')[1]}">${phaseText}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="cursor-help" data-tip="analysis_recommendation">Recomendação:</span>
                                    <span class="analysis-recommendation ${i.holderPhase === 'accumulation' ? 'text-green-400' : i.holderPhase === 'profit_taking' ? 'text-red-400' : 'text-blue-400'}">${recommendation}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="cursor-help" data-tip="analysis_horizon">Horizonte:</span>
                                    <span class="analysis-horizon">${horizon}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="cursor-help" data-tip="analysis_confidence">Confiança:</span>
                                    <span class="analysis-confidence ${confidence === 'Alta' ? 'text-green-400' : confidence === 'Moderada' ? 'text-blue-400' : 'text-yellow-400'}">${confidence}</span>
                                </div>
                            `;
                        }
                    }
                    
                    // Adicionar gráfico se o card estiver expandido
                    if (!card.querySelector('.card-body').classList.contains('hidden')) {
                        App.UI.updateChart(card);
                    }
                },
                
                updateChart: (card) => {
                    const sym = card.dataset.symbol;
                    const c = card.querySelector('.chart-container');
                    if (!c || c.querySelector('canvas')) return; // Já tem gráfico
                    
                    c.innerHTML='';
                    
                    let chart = LightweightCharts.createChart(c, {
                        layout:{background:{color:'#000000'},textColor:'#6b7280'},
                        grid:{vertLines:{color:'#1f2937'},horzLines:{color:'#1f2937'}},
                        timeScale:{timeVisible:true, secondsVisible:false}
                    });
                    
                    let s = chart.addCandlestickSeries({upColor:'#10b981',downColor:'#ef4444'});
                    let d = App.Core.getOHLC(sym, "1d");
                    s.setData(d.map(x=>({time:x.time/1000,open:x.open,high:x.high,low:x.low,close:x.close})));
                    
                    // Adicionar SMA200
                    let smaLine = chart.addLineSeries({
                        color: '#3b82f6',
                        lineWidth: 2,
                        lineStyle: 0
                    });
                    
                    const closes = d.map(x => x.close);
                    const sma200Data = [];
                    for (let i = 0; i < closes.length; i++) {
                        if (i >= 199) {
                            const sma = closes.slice(i-199, i+1).reduce((a,b) => a + b, 0) / 200;
                            sma200Data.push({time: d[i].time/1000, value: sma});
                        }
                    }
                    smaLine.setData(sma200Data);
                    
                    chart.timeScale().fitContent();
                },
                
                toggleCard: (el) => {
                    let card = el.closest('.card');
                    if(!card) return;
                    
                    let b = card.querySelector('.card-body');
                    if(b.classList.contains('hidden')) {
                        document.querySelectorAll('.card-body').forEach(e=>e.classList.add('hidden'));
                        b.classList.remove('hidden');
                        card.scrollIntoView({behavior:'smooth',block:'center'});
                        
                        // Atualizar gráfico
                        App.UI.updateChart(card);
                    } else {
                        b.classList.add('hidden');
                    }
                }
            },

            // 6. ALERTAS HOLDER
            Alerts: {
                saveToStorage: () => localStorage.setItem("holder_alerts", JSON.stringify(App.State.alerts)),
                
                openModal: (btn = null) => {
                    const modal = document.getElementById('alertsModal');
                    const symbolSelect = document.getElementById('alert-symbol');
                    
                    symbolSelect.innerHTML = '<option value="">Selecione um ativo</option>';
                    App.State.tokens.forEach(token => {
                        const option = document.createElement('option');
                        option.value = token.symbol;
                        option.textContent = `${token.name} (${token.symbol.replace('USDT', '')})`;
                        symbolSelect.appendChild(option);
                    });
                    
                    if (btn) {
                        const card = btn.closest('.card');
                        const symbol = card.dataset.symbol;
                        if (symbol) {
                            symbolSelect.value = symbol;
                        }
                    }
                    
                    document.getElementById('alert-price').value = '';
                    document.getElementById('alert-notes').value = '';
                    
                    modal.classList.remove('hidden');
                },
                
                openForSymbol: (symbol) => {
                    App.Alerts.openModal();
                    document.getElementById('alert-symbol').value = symbol;
                },
                
                closeModal: () => {
                    document.getElementById('alertsModal').classList.add('hidden');
                },
                
                createAlert: () => {
                    const symbol = document.getElementById('alert-symbol').value;
                    const type = document.getElementById('alert-type').value;
                    const price = parseFloat(document.getElementById('alert-price').value);
                    const metric = document.getElementById('alert-metric').value;
                    const notes = document.getElementById('alert-notes').value;
                    
                    if (!symbol || !price || isNaN(price)) {
                        alert('Preencha ativo e preço alvo válido!');
                        return;
                    }
                    
                    const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || 0;
                    const percent = currentPrice ? ((price - currentPrice) / currentPrice) * 100 : 0;
                    
                    const alert = {
                        id: Date.now(),
                        symbol: symbol.toUpperCase(),
                        type,
                        targetPrice: price,
                        metric,
                        currentPrice,
                        percent,
                        notes,
                        createdAt: new Date().toLocaleString(),
                        triggered: false,
                        triggeredAt: null,
                        actualPrice: null
                    };
                    
                    App.State.alerts.push(alert);
                    App.Alerts.saveToStorage();
                    App.Alerts.renderAlertsPanel();
                    App.Alerts.closeModal();
                    
                    App.Alerts.renderInCard(symbol);
                },
                
                openForCard: (btn) => {
                    App.Alerts.openModal(btn);
                },
                
                checkAlerts: (symbol, currentPrice) => {
                    if (!symbol || !currentPrice) return;
                    
                    const symbolUpper = symbol.toUpperCase();
                    let triggeredAny = false;
                    
                    App.State.alerts.forEach(alert => {
                        if (alert.symbol === symbolUpper && !alert.triggered) {
                            let shouldTrigger = false;
                            
                            if (alert.type === 'dca_buy' && currentPrice <= alert.targetPrice) {
                                shouldTrigger = true;
                            } else if (alert.type === 'profit_take' && currentPrice >= alert.targetPrice) {
                                shouldTrigger = true;
                            }
                            
                            if (shouldTrigger) {
                                alert.triggered = true;
                                alert.triggeredAt = new Date().toLocaleString();
                                alert.actualPrice = currentPrice;
                                triggeredAny = true;
                                
                                App.Alerts.showNotification(alert);
                            }
                        }
                    });
                    
                    if (triggeredAny) {
                        App.Alerts.saveToStorage();
                        App.Alerts.renderAlertsPanel();
                        App.Alerts.renderInCard(symbolUpper);
                    }
                },
                
                showNotification: (alert) => {
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
                        alert.type === 'dca_buy' ? 'bg-green-900 border-green-500' : 'bg-orange-900 border-orange-500'
                    } border`;
                    
                    notification.innerHTML = `
                        <div class="flex items-center gap-3">
                            <i class="fa-solid ${alert.type === 'dca_buy' ? 'fa-arrow-down text-green-400' : 'fa-arrow-up text-orange-400'}"></i>
                            <div>
                                <strong class="text-white">${alert.symbol.replace('USDT', '')}</strong>
                                <div class="text-sm ${alert.type === 'dca_buy' ? 'text-green-300' : 'text-orange-300'}">
                                    ${alert.type === 'dca_buy' ? 'DCA: Comprar a' : 'Realizar: Vender a'} $${alert.targetPrice.toFixed(2)}
                                </div>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" class="text-gray-400 hover:text-white">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentElement) {
                            notification.remove();
                        }
                    }, 10000);
                },
                
                remove: (id) => {
                    App.State.alerts = App.State.alerts.filter(alert => alert.id !== id);
                    App.Alerts.saveToStorage();
                    App.Alerts.renderAlertsPanel();
                    
                    App.State.tokens.forEach(token => {
                        App.Alerts.renderInCard(token.symbol);
                    });
                },
                
                calculateRemainingPercent: (alert) => {
                    const currentPrice = App.State.marketData[alert.symbol.toLowerCase()]?.lastPrice || alert.currentPrice;
                    if (!currentPrice) return alert.percent;
                    
                    const remainingPercent = ((alert.targetPrice - currentPrice) / currentPrice) * 100;
                    return Math.abs(remainingPercent);
                },
                
                getAlertColorClass: (alert) => {
                    if (alert.triggered) {
                        return 'bg-green-900/20 border-green-500';
                    }
                    
                    const remainingPercent = App.Alerts.calculateRemainingPercent(alert);
                    if (remainingPercent <= 5) {
                        return 'bg-yellow-900/20 border-yellow-500';
                    } else {
                        return 'bg-red-900/20 border-red-500';
                    }
                },
                
                renderAlertsPanel: () => {
                    const container = document.getElementById('alertsContent');
                    
                    if (App.State.alerts.length === 0) {
                        container.innerHTML = '<div class="text-gray-500 text-center py-4 text-sm">Configure alertas DCA para acumulação inteligente</div>';
                        return;
                    }
                    
                    const sortedAlerts = [...App.State.alerts].sort((a, b) => {
                        const aRemaining = App.Alerts.calculateRemainingPercent(a);
                        const bRemaining = App.Alerts.calculateRemainingPercent(b);
                        return aRemaining - bRemaining;
                    });
                    
                    container.innerHTML = '';
                    sortedAlerts.forEach(alert => {
                        const currentPrice = App.State.marketData[alert.symbol.toLowerCase()]?.lastPrice || alert.currentPrice;
                        const remainingPercent = App.Alerts.calculateRemainingPercent(alert);
                        const isDCA = alert.type === 'dca_buy';
                        
                        const colorClass = App.Alerts.getAlertColorClass(alert);
                        const textColor = alert.triggered ? 'text-green-400' : 
                                         remainingPercent <= 5 ? 'text-yellow-400' : 'text-red-400';
                        
                        const alertEl = document.createElement('div');
                        alertEl.className = `p-3 rounded border mb-2 ${colorClass}`;
                        
                        alertEl.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <strong class="${textColor}">${alert.symbol.replace('USDT', '')}</strong>
                                    <span class="text-xs ${isDCA ? 'text-green-500' : 'text-orange-500'} ml-2">${isDCA ? 'DCA' : 'REALIZAR'}</span>
                                    ${alert.triggered ? '<span class="text-xs text-green-300 ml-2">✓ ATINGIDO</span>' : ''}
                                </div>
                                <button onclick="App.Alerts.remove(${alert.id})" class="text-gray-500 hover:text-red-500 text-xs">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                            <div class="mt-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Alvo:</span>
                                    <span class="text-white">$${alert.targetPrice.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">Atual:</span>
                                    <span class="text-white">$${currentPrice.toFixed(2)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-400">${alert.triggered ? 'Atingido em:' : 'Falta:'}</span>
                                    <span class="${textColor}">
                                        ${alert.triggered ? 
                                            alert.triggeredAt.split(' ')[0] : 
                                            remainingPercent.toFixed(1) + '%'
                                        }
                                    </span>
                                </div>
                                ${alert.notes ? `<div class="mt-1 text-xs text-gray-500">${alert.notes}</div>` : ''}
                            </div>
                        `;
                        
                        container.appendChild(alertEl);
                    });
                },
                
                renderInCard: (symbol) => {
                    const card = document.querySelector(`.card[data-symbol="${symbol}"]`);
                    if (!card) return;
                    
                    const alertList = card.querySelector('.alert-list');
                    const alerts = App.State.alerts.filter(alert => alert.symbol === symbol);
                    
                    if (alerts.length === 0) {
                        alertList.innerHTML = '<div class="text-gray-500 text-center py-2 text-xs">Sem alertas DCA</div>';
                        return;
                    }
                    
                    const sortedAlerts = [...alerts].sort((a, b) => {
                        const aRemaining = App.Alerts.calculateRemainingPercent(a);
                        const bRemaining = App.Alerts.calculateRemainingPercent(b);
                        return aRemaining - bRemaining;
                    });
                    
                    alertList.innerHTML = '';
                    sortedAlerts.forEach(alert => {
                        const currentPrice = App.State.marketData[symbol.toLowerCase()]?.lastPrice || alert.currentPrice;
                        const remainingPercent = App.Alerts.calculateRemainingPercent(alert);
                        const isDCA = alert.type === 'dca_buy';
                        
                        let bgColor = 'bg-red-900/30', borderColor = 'border-red-700/30', textColor = 'text-red-400';
                        
                        if (alert.triggered) {
                            bgColor = 'bg-green-900/30';
                            borderColor = 'border-green-700/30';
                            textColor = 'text-green-400';
                        } else if (remainingPercent <= 5) {
                            bgColor = 'bg-yellow-900/30';
                            borderColor = 'border-yellow-700/30';
                            textColor = 'text-yellow-400';
                        }
                        
                        const alertEl = document.createElement('div');
                        alertEl.className = `flex justify-between items-center p-1 rounded text-xs ${bgColor} ${borderColor} border mb-1`;
                        alertEl.innerHTML = `
                            <span class="${textColor} font-bold">${isDCA ? 'D' : 'R'}</span>
                            <span class="text-white text-[10px]">$${alert.targetPrice.toFixed(2)}</span>
                            <span class="${textColor} text-[10px]">
                                ${alert.triggered ? '✓' : remainingPercent.toFixed(1) + '%'}
                            </span>
                            <button onclick="App.Alerts.remove(${alert.id})" class="text-red-500 text-[8px] hover:text-red-300">×</button>
                        `;
                        
                        alertList.appendChild(alertEl);
                    });
                },
                
                checkAllAlerts: () => {
                    App.State.tokens.forEach(token => {
                        const currentPrice = App.State.marketData[token.symbol.toLowerCase()]?.lastPrice;
                        if (currentPrice) {
                            App.Alerts.checkAlerts(token.symbol, currentPrice);
                        }
                    });
                }
            },

            // 7. TOKEN MANAGEMENT HOLDER
            Token: {
                add: async () => {
                    const input = document.getElementById('add-input');
                    let val = input.value.trim().toUpperCase();
                    if (!val) return;
                    
                    // Verificar formato nome:símbolo
                    let name = '', symbol = '';
                    if (val.includes(':')) {
                        const parts = val.split(':');
                        name = parts[0].trim();
                        symbol = parts[1].trim().toUpperCase();
                    } else {
                        name = val;
                        symbol = val.toUpperCase();
                    }
                    
                    if (!symbol.endsWith('USDT')) {
                        symbol = symbol + 'USDT';
                    }
                    
                    // Verificar se já existe
                    if (App.State.tokens.some(t => t.symbol === symbol)) { 
                        alert('Ativo já na lista.'); 
                        return; 
                    }
                    
                    try {
                        const res = await fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`);
                        const data = await res.json();
                        if (data.symbol) {
                            App.State.tokens.push({symbol, name});
                            localStorage.setItem('holder_tokens', JSON.stringify(App.State.tokens));
                            location.reload();
                        } else { 
                            alert('Ativo não encontrado na Binance.'); 
                        }
                    } catch (e) { 
                        alert('Erro de validação. Verifique se o símbolo está correto.'); 
                    }
                },
                
                rem: (symbol) => {
                    App.State.tokens = App.State.tokens.filter(x => x.symbol !== symbol);
                    localStorage.setItem('holder_tokens', JSON.stringify(App.State.tokens));
                    location.reload();
                },
                
                addBatch: () => {
                    const textarea = document.getElementById('batch-tokens');
                    const lines = textarea.value.trim().split('\n');
                    let added = 0;
                    
                    lines.forEach(line => {
                        line = line.trim();
                        if (!line) return;
                        
                        let name = '', symbol = '';
                        if (line.includes(':')) {
                            const parts = line.split(':');
                            name = parts[0].trim();
                            symbol = parts[1].trim().toUpperCase();
                        } else {
                            name = line;
                            symbol = line.toUpperCase();
                        }
                        
                        if (!symbol.endsWith('USDT')) {
                            symbol = symbol + 'USDT';
                        }
                        
                        if (!App.State.tokens.some(t => t.symbol === symbol)) {
                            App.State.tokens.push({symbol, name});
                            added++;
                        }
                    });
                    
                    if (added > 0) {
                        localStorage.setItem('holder_tokens', JSON.stringify(App.State.tokens));
                        alert(`${added} ativos adicionados com sucesso!`);
                        location.reload();
                    } else {
                        alert('Nenhum ativo novo foi adicionado.');
                    }
                },
                
                removeSelected: () => {
                    const checkboxes = document.querySelectorAll('#settings-tokens-list .token-checkbox:checked');
                    if (checkboxes.length === 0) {
                        alert('Selecione pelo menos um ativo para remover.');
                        return;
                    }
                    
                    const symbolsToRemove = Array.from(checkboxes).map(cb => cb.value);
                    App.State.tokens = App.State.tokens.filter(t => !symbolsToRemove.includes(t.symbol));
                    localStorage.setItem('holder_tokens', JSON.stringify(App.State.tokens));
                    
                    App.Settings.renderTokensList();
                    App.UI.grid();
                    App.UI.tables();
                    App.Portfolio.generate();
                    
                    alert(`${symbolsToRemove.length} ativos removidos com sucesso!`);
                }
            },

            // 8. SETTINGS HOLDER
            Settings: {
                openModal: () => {
                    document.getElementById('settingsModal').classList.remove('hidden');
                    App.Settings.renderTokensList();
                },
                
                closeModal: () => document.getElementById('settingsModal').classList.add('hidden'),
                
                setStrategy: (strategy) => {
                    App.State.settings.strategy = strategy;
                    App.State.portfolioStrategy = strategy;
                    document.querySelectorAll('#settingsModal button').forEach(btn => {
                        btn.classList.remove('border-holder-accumulation');
                        btn.classList.add('border-gray-700');
                    });
                    event.target.classList.remove('border-gray-700');
                    event.target.classList.add('border-holder-accumulation');
                    App.Portfolio.generate();
                },
                
                save: () => {
                    localStorage.setItem('holder_settings', JSON.stringify(App.State.settings));
                    App.Settings.closeModal();
                    App.Portfolio.generate();
                },
                
                renderTokensList: () => {
                    const container = document.getElementById('settings-tokens-list');
                    container.innerHTML = '';
                    
                    App.State.tokens.forEach(token => {
                        const tokenEl = document.createElement('span');
                        tokenEl.className = 'bg-dark-800 px-2 py-1 rounded border border-gray-600 text-xs flex gap-2 items-center';
                        tokenEl.innerHTML = `
                            <input type="checkbox" class="token-checkbox" value="${token.symbol}">
                            <span>${token.name} (${token.symbol.replace('USDT', '')})</span>
                        `;
                        container.appendChild(tokenEl);
                    });
                }
            },

            // 9. EXPORT HOLDER
            Export: {
                openModal: () => document.getElementById('export-modal').classList.remove('hidden'),
                closeModal: () => document.getElementById('export-modal').classList.add('hidden'),
                gen: (type) => {
                    if (type === 'xlsx') {
                        const data = App.UI.getAllTokenData();
                        const ws = XLSX.utils.json_to_sheet(data);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Holder Report");
                        XLSX.writeFile(wb, "CryptoPanelHolder_Report.xlsx");
                    } else if (type === 'portfolio') {
                        // Exportar portfólio recomendado
                        const portfolioData = [];
                        const allData = App.UI.getAllTokenData();
                        
                        allData.forEach(token => {
                            portfolioData.push({
                                'Ativo': token.symbol.replace('USDT', ''),
                                'Nome': token.name,
                                'Preço Atual': token.price,
                                'Score Holder': token.holderScore,
                                'Fase': token.holderPhase === 'accumulation' ? 'Acumular' : 
                                       token.holderPhase === 'profit_taking' ? 'Realizar' : 'Manter',
                                'Alocação Sugerida': '0%', // Seria calculada baseado na estratégia
                                'Preço Entrada Ideal': token.price * 0.85,
                                'Alvo 1 Ano': token.price * (1 + (token.holderScore / 100)),
                                'Notas': `Risco: ${token.riskLevel} | Posição Histórica: ${token.historicalPercentile?.toFixed(0) || '--'}%`
                            });
                        });
                        
                        const ws = XLSX.utils.json_to_sheet(portfolioData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Portfolio Holder");
                        XLSX.writeFile(wb, "Portfolio_Holder_Recomendado.xlsx");
                    }
                    
                    App.Export.closeModal();
                }
            }
        };

        // Inicialização
        App.Core.onOHLCUpdate((s, tf) => {
            App.UI.updateTokenCard(s.toUpperCase());
            App.UI.tables();
            App.Portfolio.generate();
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            App.Core.init();
            document.getElementById('refreshData').addEventListener('click', App.Core.refreshData);
            document.getElementById('openSettings').addEventListener('click', App.Settings.openModal);
            document.getElementById('searchToken').addEventListener('input', (e) => {
                const term = e.target.value.toUpperCase();
                document.querySelectorAll('.card').forEach(c => {
                    const symbol = c.dataset.symbol;
                    const name = c.querySelector('.symbol-name')?.textContent || '';
                    c.style.display = (symbol.includes(term) || name.toUpperCase().includes(term)) ? 'flex' : 'none';
                });
            });
        });
    </script>
</body>
</html>
